<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamisch Sport Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        .table thead th { background-color: #f8f9fa; }
        #chart-container { margin-top: 40px; }
        .alert-server { margin-top: 20px; }
        .loading { text-align: center; padding: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Dynamisch Sport Dashboard Overzicht</h1>
        <p class="lead">Dit dashboard wordt automatisch bijgewerkt telkens wanneer u het opent, op basis van de nieuwste gegevens in het bestand **activities.csv** in dezelfde map.</p>

        <div class="alert alert-warning alert-server" role="alert">
            <strong>Let op:</strong> Als het dashboard niet laadt, moet u de pagina mogelijk via een lokale webserver openen vanwege browserbeveiliging.
        </div>

        <hr>

        <h2>Totale Afstand per Sport per Jaar (Grafiek)</h2>
        <div id="chart-container">
            <div id="vega-chart" class="loading">Gegevens worden geladen en verwerkt...</div>
        </div>

        <hr>

        <h2>Gedetailleerde Gegevens per Sport en Jaar (Tabel)</h2>
        <div id="table-container" class="table-container">
            <div class="loading">Tabel wordt geladen...</div>
        </div>
    </div>

    <script>
        // Bestandsnaam is hier vastgelegd op CSV voor eenvoudige parsing
        const FILENAME = './activities1.csv'; 

        // Hulplijst voor Nederlandse maandnamen
        const monthReplacements = {
            'jan': 'Jan', 'feb': 'Feb', 'mrt': 'Mar', 'apr': 'Apr',
            'mei': 'May', 'jun': 'Jun', 'jul': 'Jul', 'aug': 'Aug',
            'sep': 'Sep', 'okt': 'Oct', 'nov': 'Nov', 'dec': 'Dec'
        };

        /**
         * Schone datumstring op door Nederlandse maandnamen te vervangen
         * en een parseerbare Date object te retourneren.
         */
        function parseDutchDate(dateStr) {
            let cleanedStr = dateStr;
            for (const nl in monthReplacements) {
                if (cleanedStr.includes(nl)) {
                    cleanedStr = cleanedStr.replace(nl, monthReplacements[nl]);
                }
            }
            // Probeer nu de datum te parsen met de geconverteerde string
            return new Date(cleanedStr);
        }

        /**
         * Simpele CSV-parser: splitst op rijen en vervolgens op komma's
         * en retourneert een array van objecten.
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            // De header bevat 99 kolommen, we focussen op de essentiÃ«le
            const headers = lines[0].split(',').map(h => h.trim().replace(/['"]+/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // Simpele split op komma's
                const values = lines[i].split(',');
                if (values.length !== headers.length) continue;

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index].trim().replace(/['"]+/g, '');
                });
                data.push(row);
            }
            return data;
        }

        /**
         * Hoofdfunctie om data te laden, verwerken en te renderen
         */
        async function loadDataAndRender() {
            try {
                const response = await fetch(FILENAME);
                if (!response.ok) {
                    throw new Error(`Fout bij laden: ${response.statusText}. Controleer of u een lokale server gebruikt.`);
                }
                const csvText = await response.text();
                const rawData = parseCSV(csvText);

                // --- 1. Data Cleaning en Transformatie ---
                const data = rawData.map(d => {
                    const date = parseDutchDate(d['Datum van activiteit']);
                    
                    // Gebruik Afstand.1 (in meters) en Beweegtijd (in seconden)
                    const afstandM = parseFloat(d['Afstand.1']) || 0;
                    const beweegtijdSec = parseFloat(d['Beweegtijd']) || 0;
                    const avgHR = parseFloat(d['Gemiddelde hartslag']) || NaN;
                    
                    return {
                        Jaar: date.getFullYear(),
                        Sport: d['Activiteitstype'] || 'Onbekend',
                        Afstand_km: afstandM / 1000,
                        Beweegtijd_uur: beweegtijdSec / 3600,
                        Gem_hartslag: avgHR,
                        Activiteits_ID: d['Activiteits-ID']
                    };
                }).filter(d => !isNaN(d.Jaar)); // filter ongeldige datums

                // --- 2. Aggregatie ---
                const aggregatedMap = new Map();

                data.forEach(d => {
                    const key = `${d.Jaar}-${d.Sport}`;
                    if (!aggregatedMap.has(key)) {
                        aggregatedMap.set(key, {
                            Jaar: d.Jaar,
                            Sport: d.Sport,
                            Aantal_activiteiten: 0,
                            Totale_afstand_km: 0,
                            Totale_tijd_uur: 0,
                            Activiteiten_met_HR: 0,
                            Totale_HR: 0
                        });
                    }

                    const agg = aggregatedMap.get(key);
                    agg.Aantal_activiteiten += 1;
                    agg.Totale_afstand_km += d.Afstand_km;
                    agg.Totale_tijd_uur += d.Beweegtijd_uur;
                    
                    if (!isNaN(d.Gem_hartslag) && d.Gem_hartslag > 0) {
                        agg.Activiteiten_met_HR += 1;
                        agg.Totale_HR += d.Gem_hartslag;
                    }
                });

                const dashboardData = Array.from(aggregatedMap.values()).map(agg => ({
                    Jaar: String(agg.Jaar), // Jaar als string voor categorische as
                    Sport: agg.Sport,
                    Aantal_activiteiten: agg.Aantal_activiteiten,
                    Totale_afstand_km: agg.Totale_afstand_km,
                    Totale_tijd_uur: agg.Totale_tijd_uur,
                    Gemiddelde_hartslag: agg.Activiteiten_met_HR > 0 ? (agg.Totale_HR / agg.Activiteiten_met_HR) : null
                }));

                dashboardData.sort((a, b) => {
                    if (a.Jaar !== b.Jaar) return a.Jaar - b.Jaar;
                    return b.Totale_afstand_km - a.Totale_afstand_km;
                });

                // --- 3. Rendering ---
                renderChart(dashboardData);
                renderTable(dashboardData);

            } catch (error) {
                console.error("Fout bij het laden van het dashboard:", error);
                document.getElementById('vega-chart').innerHTML = `<div class="alert alert-danger" role="alert">Fout bij het laden van de gegevens. Controleer de console voor details. ${error.message}</div>`;
                document.getElementById('table-container').innerHTML = `<div class="alert alert-danger" role="alert">Fout bij het laden van de gegevens. Controleer de console voor details. ${error.message}</div>`;
            }
        }

        /**
         * Render de Altair/Vega-Lite grafiek
         */
        function renderChart(data) {
            const plotData = data.filter(d => d.Totale_afstand_km > 0);

            const spec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": plotData},
                "mark": "bar",
                "encoding": {
                    "x": {"field": "Jaar", "type": "nominal", "title": "Jaar"},
                    "y": {"field": "Totale_afstand_km", "type": "quantitative", "title": "Totale Afstand (km)"},
                    "color": {"field": "Sport", "type": "nominal", "title": "Sport"},
                    "tooltip": [
                        {"field": "Jaar", "title": "Jaar"},
                        {"field": "Sport", "title": "Sport"},
                        {"field": "Aantal_activiteiten", "title": "Aantal activiteiten", "format": ".0f"},
                        {"field": "Totale_afstand_km", "title": "Totale afstand (km)", "format": ".1f"},
                        {"field": "Totale_tijd_uur", "title": "Totale tijd (uur)", "format": ".1f"},
                        {"field": "Gemiddelde_hartslag", "title": "Gem. hartslag", "format": ".0f"}
                    ]
                },
                "properties": {
                    "title": "Totale Afstand per Sport per Jaar"
                },
                "config": {
                    "view": {"stroke": "transparent"},
                    "axis": {"grid": true}
                },
                "selection": {
                    "grid": {"type": "interval", "bind": "scales"}
                }
            };
            
            vegaEmbed('#vega-chart', spec, { actions: true }).then(() => {
                document.getElementById('vega-chart').classList.remove('loading');
            });
        }

        /**
         * Render de HTML-tabel
         */
        function renderTable(data) {
            let html = `
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Jaar</th>
                        <th>Sport</th>
                        <th>Aantal activiteiten</th>
                        <th>Afstand (km)</th>
                        <th>Tijd (uur)</th>
                        <th>Gem. hartslag</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.forEach(d => {
                const distance = d.Totale_afstand_km.toLocaleString('nl-NL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                const time = d.Totale_tijd_uur.toLocaleString('nl-NL', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                const hr = d.Gemiddelde_hartslag ? Math.round(d.Gemiddelde_hartslag) : '-';

                html += `
                    <tr>
                        <td>${d.Jaar}</td>
                        <td>${d.Sport}</td>
                        <td>${d.Aantal_activiteiten}</td>
                        <td>${distance}</td>
                        <td>${time}</td>
                        <td>${hr}</td>
                    </tr>
                `;
            });

            html += `
                </tbody>
            </table>
            `;

            document.getElementById('table-container').innerHTML = html;
            document.getElementById('table-container').classList.remove('loading');
        }

        // Start het proces bij het laden van de pagina
        document.addEventListener('DOMContentLoaded', loadDataAndRender);
    </script>
</body>
</html>
